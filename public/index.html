<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo Harbor | 代办事项中心</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="bg-orb orb-1" aria-hidden="true"></div>
    <div class="bg-orb orb-2" aria-hidden="true"></div>

    <main class="shell">
      <header class="topbar">
        <div>
          <p class="eyebrow">Todo Harbor</p>
          <h1>你的代办事项港湾</h1>
          <p class="subtitle">自动保存历史待办与完成状态，刷新页面不会丢失。</p>
          <p class="build-info" id="buildInfo">版本 --</p>
        </div>
        <div class="topbar-actions">
          <span class="status-pill is-hidden" id="syncStatus">已连接</span>
          <nav class="route-nav" aria-label="主导航">
            <a id="appNavLink" class="route-link" href="/app">代办</a>
            <a id="settingsNavLink" class="route-link" href="/settings">账号设置</a>
            <a id="authNavLink" class="route-link" href="/auth">登录/注册</a>
          </nav>
          <div class="user-bar is-hidden" id="userBar">
            <span id="userEmail"></span>
            <button id="logoutButton" class="secondary-button compact-button" type="button">退出登录</button>
          </div>
        </div>
      </header>

      <section class="panel auth-panel" id="authPanel" aria-label="登录注册">
        <div class="auth-head">
          <div>
            <p class="auth-kicker">账号</p>
            <h2>登录后同步待办</h2>
            <p class="auth-note">注册后数据只对当前账号可见。</p>
          </div>
          <div class="auth-modes" role="tablist" aria-label="登录注册模式">
            <button class="auth-mode is-active" data-auth-mode="login" role="tab" aria-selected="true">登录</button>
            <button class="auth-mode" data-auth-mode="register" role="tab" aria-selected="false">注册</button>
          </div>
        </div>
        <form id="authForm" class="auth-form">
          <label class="field" for="authEmail">
            <span>邮箱</span>
            <input id="authEmail" type="email" autocomplete="email" placeholder="name@example.com" />
          </label>
          <label class="field" for="authPassword">
            <span>密码</span>
            <input id="authPassword" type="password" autocomplete="current-password" placeholder="至少 8 位" />
          </label>
          <label class="field is-hidden" id="authPasswordConfirmField" for="authPasswordConfirm">
            <span>确认密码</span>
            <input id="authPasswordConfirm" type="password" autocomplete="new-password" placeholder="再次输入密码" />
          </label>
          <div id="authRegisterActions" class="auth-actions is-hidden">
            <button type="button" id="requestRegisterCodeButton" class="secondary-button">发送注册验证码</button>
          </div>
          <label class="field is-hidden" id="authRegisterCodeField" for="authRegisterCode">
            <span>邮箱验证码</span>
            <input id="authRegisterCode" type="text" inputmode="numeric" placeholder="输入 6 位验证码" />
          </label>
          <p id="authMessage" class="auth-message"></p>
          <div class="auth-actions">
            <button type="submit" id="authSubmitButton">登录</button>
          </div>
          <button type="button" id="resetToggleButton" class="link-button">忘记密码？</button>
        </form>

        <div id="resetPanel" class="reset-panel is-hidden">
          <label class="field" for="resetEmail">
            <span>邮箱</span>
            <input id="resetEmail" type="email" autocomplete="email" placeholder="name@example.com" />
          </label>
          <label class="field" for="resetToken">
            <span>重置码</span>
            <input id="resetToken" type="text" placeholder="邮件中收到的重置码" />
          </label>
          <label class="field" for="resetNewPassword">
            <span>新密码</span>
            <input id="resetNewPassword" type="password" autocomplete="new-password" placeholder="至少 8 位" />
          </label>
          <p id="resetMessage" class="auth-message"></p>
          <div class="reset-actions">
            <button type="button" id="requestResetButton" class="secondary-button">发送重置码</button>
            <button type="button" id="confirmResetButton">重置密码</button>
          </div>
        </div>
      </section>

      <section class="panel account-panel is-hidden" id="accountPanel" aria-label="账号设置">
        <div class="account-head">
          <div>
            <p class="account-kicker">账号设置</p>
            <h2>管理邮箱与密码</h2>
            <p class="account-note">可在此验证邮箱、修改邮箱或更新密码。</p>
          </div>
        </div>

        <div class="account-grid">
          <article class="account-card">
            <h3>邮箱验证</h3>
            <p class="account-meta">
              当前邮箱：<span id="accountEmail">-</span>
              <span id="verifyStatus" class="verify-status">未验证</span>
            </p>
            <div class="account-actions">
              <button type="button" id="requestVerifyButton" class="secondary-button compact-button">发送验证邮件</button>
            </div>
            <label class="field" for="verifyTokenInput">
              <span>验证码</span>
              <input id="verifyTokenInput" type="text" placeholder="输入邮箱验证码" />
            </label>
            <button type="button" id="verifyEmailButton">验证邮箱</button>
          </article>

          <article class="account-card">
            <h3>修改邮箱</h3>
            <label class="field" for="newEmailInput">
              <span>新邮箱</span>
              <input id="newEmailInput" type="email" autocomplete="email" placeholder="new@example.com" />
            </label>
            <label class="field" for="confirmEmailPasswordInput">
              <span>当前密码</span>
              <input id="confirmEmailPasswordInput" type="password" autocomplete="current-password" />
            </label>
            <button type="button" id="changeEmailButton">更新邮箱</button>
          </article>

          <article class="account-card">
            <h3>修改密码</h3>
            <label class="field" for="currentPasswordInput">
              <span>当前密码</span>
              <input id="currentPasswordInput" type="password" autocomplete="current-password" />
            </label>
            <label class="field" for="newPasswordInput">
              <span>新密码</span>
              <input id="newPasswordInput" type="password" autocomplete="new-password" />
            </label>
            <button type="button" id="changePasswordButton">更新密码</button>
          </article>
        </div>

        <p id="accountMessage" class="account-message"></p>
      </section>

      <section class="panel composer-panel" id="composerPanel" aria-label="创建待办">
        <div class="composer-head">
          <div>
            <p class="composer-kicker">新增任务</p>
            <h2>结构化录入区</h2>
            <p class="composer-note">支持单条创建、按到期日期批量创建、挂载父任务形成层级。</p>
          </div>
          <div class="compose-modes" role="tablist" aria-label="新增模式">
            <button class="compose-mode is-active" data-compose-mode="single" role="tab" aria-selected="true">
              单条录入
            </button>
            <button class="compose-mode" data-compose-mode="batch" role="tab" aria-selected="false">
              批量录入
            </button>
          </div>
        </div>

        <form id="todoForm" class="composer-form">
          <div class="composer-grid">
            <div class="composer-left">
              <label class="field" for="todoInput" id="singleInputField">
                <span>任务标题</span>
                <input
                  id="todoInput"
                  name="title"
                  type="text"
                  maxlength="200"
                  placeholder="比如：整理本周项目周报"
                  autocomplete="off"
                />
              </label>

              <label class="field is-hidden" for="todoBatchInput" id="batchInputField">
                <span>批量任务（每行一条）</span>
                <textarea
                  id="todoBatchInput"
                  name="titles"
                  rows="5"
                  placeholder="例如：&#10;完成接口联调&#10;补充回归测试&#10;更新发布文档"
                ></textarea>
                <small>批量模式会按当前项目、到期日期、父任务统一创建。</small>
              </label>

              <div class="composer-extra">
                <label class="field" for="projectInput">
                  <span>项目</span>
                  <input
                    id="projectInput"
                    name="project"
                    type="text"
                    maxlength="80"
                    list="projectSuggestions"
                    value="默认项目"
                    placeholder="如：订单中心"
                  />
                </label>

                <label class="field" for="dueDateInput">
                  <span>到期日期</span>
                  <input id="dueDateInput" name="dueDate" type="date" />
                </label>

                <label class="field" for="reminderAtInput">
                  <span>提醒时间</span>
                  <input id="reminderAtInput" name="reminderAt" type="datetime-local" />
                </label>

                <label class="field" for="parentSelect">
                  <span>父任务</span>
                  <select id="parentSelect" name="parentId">
                    <option value="">顶级任务（无父级）</option>
                  </select>
                </label>

                <label class="field" for="priorityInput">
                  <span>优先级</span>
                  <select id="priorityInput" name="priority">
                    <option value="medium">中优先级</option>
                    <option value="high">高优先级</option>
                    <option value="low">低优先级</option>
                  </select>
                </label>

                <label class="field" for="statusInput">
                  <span>任务状态</span>
                  <select id="statusInput" name="status">
                    <option value="todo">待开始</option>
                    <option value="in_progress">进行中</option>
                    <option value="blocked">阻塞中</option>
                  </select>
                </label>

                <label class="field" for="recurrenceInput">
                  <span>重复周期</span>
                  <select id="recurrenceInput" name="recurrence">
                    <option value="none">不重复</option>
                    <option value="daily">每天</option>
                    <option value="weekly">每周</option>
                    <option value="monthly">每月</option>
                  </select>
                </label>
              </div>

              <label class="field" for="tagsInput">
                <span>标签（逗号分隔）</span>
                <input
                  id="tagsInput"
                  name="tags"
                  type="text"
                  maxlength="260"
                  placeholder="例如：紧急, 前端, 本周"
                  autocomplete="off"
                />
              </label>

              <div class="composer-helpers">
                <div class="quick-dates" aria-label="快捷到期日期">
                  <button type="button" class="quick-date" data-days-offset="0">今天</button>
                  <button type="button" class="quick-date" data-days-offset="1">明天</button>
                  <button type="button" class="quick-date" data-days-offset="7">一周后</button>
                  <button type="button" class="quick-date" data-clear-date="true">清除到期日</button>
                </div>
                <div id="projectChips" class="project-chips" aria-label="历史项目快捷选择"></div>
              </div>
            </div>

            <aside class="composer-summary" aria-live="polite">
              <h3>创建预览</h3>
              <dl>
                <div><dt>模式</dt><dd id="summaryMode">单条录入</dd></div>
                <div><dt>预计创建</dt><dd id="summaryCount">1 条</dd></div>
                <div><dt>项目</dt><dd id="summaryProject">默认项目</dd></div>
                <div><dt>到期日期</dt><dd id="summaryDate">未设置到期日</dd></div>
                <div><dt>提醒</dt><dd id="summaryReminder">未设置提醒</dd></div>
                <div><dt>父任务</dt><dd id="summaryParent">顶级任务</dd></div>
                <div><dt>重复</dt><dd id="summaryRecurrence">不重复</dd></div>
              </dl>
              <p id="summaryHint">单条模式会创建 1 条任务。</p>
            </aside>
          </div>

          <div class="composer-actions">
            <button type="submit" id="addButton">新增待办</button>
            <button type="button" id="resetComposerButton" class="secondary-button">清空输入</button>
          </div>
          <datalist id="projectSuggestions"></datalist>
        </form>
      </section>

      <section class="panel metrics-panel" id="metricsPanel" aria-label="统计数据">
        <article class="metric-card">
          <p>全部</p>
          <strong id="countAll">0</strong>
        </article>
        <article class="metric-card">
          <p>进行中</p>
          <strong id="countActive">0</strong>
        </article>
        <article class="metric-card">
          <p>已完成</p>
          <strong id="countCompleted">0</strong>
        </article>
      </section>

      <section class="panel board-panel" id="boardPanel">
        <div class="board-toolbar">
          <div class="toolbar-controls">
            <div class="filters" role="tablist" aria-label="筛选代办">
              <button class="filter is-active" data-filter="all" role="tab" aria-selected="true">
                全部
              </button>
              <button class="filter" data-filter="active" role="tab" aria-selected="false">
                进行中
              </button>
              <button class="filter" data-filter="completed" role="tab" aria-selected="false">
                已完成
              </button>
            </div>
            <div class="due-scopes" role="tablist" aria-label="到期范围">
              <button class="due-scope is-active" data-due-scope="all" role="tab" aria-selected="true">全部到期日</button>
              <button class="due-scope" data-due-scope="overdue" role="tab" aria-selected="false">仅逾期</button>
              <button class="due-scope" data-due-scope="today" role="tab" aria-selected="false">仅今天</button>
              <button class="due-scope" data-due-scope="week" role="tab" aria-selected="false">7天内</button>
              <button class="due-scope" data-due-scope="no_due" role="tab" aria-selected="false">无到期日</button>
            </div>
            <div class="view-modes" role="tablist" aria-label="视图模式">
              <button class="view-mode is-active" data-view="flat" role="tab" aria-selected="true">
                普通
              </button>
              <button class="view-mode" data-view="project" role="tab" aria-selected="false">
                按项目
              </button>
              <button class="view-mode" data-view="date" role="tab" aria-selected="false">
                按到期日
              </button>
            </div>
            <div class="toolbar-actions">
              <button id="bulkCompleteButton" class="secondary-button compact-button" type="button">
                完成当前筛选
              </button>
              <button id="bulkProjectButton" class="secondary-button compact-button" type="button">
                批量改项目
              </button>
              <button id="bulkDueDateButton" class="secondary-button compact-button" type="button">
                批量改到期日
              </button>
              <button id="exportButton" class="secondary-button compact-button" type="button">导出JSON</button>
              <button id="importButton" class="secondary-button compact-button" type="button">导入JSON</button>
              <button id="undoButton" class="secondary-button compact-button" type="button">撤销上一步</button>
              <button id="clearCompletedButton" class="danger-button" type="button">清除已完成</button>
            </div>
            <div class="query-controls" aria-label="高级筛选">
              <input id="searchInput" type="search" placeholder="搜索任务或项目" autocomplete="off" />
              <select id="projectFilterSelect">
                <option value="">全部项目</option>
              </select>
              <input id="dueFromInput" type="date" aria-label="开始到期日" />
              <input id="dueToInput" type="date" aria-label="结束到期日" />
              <select id="sortSelect" aria-label="排序方式">
                <option value="created_desc">最新创建</option>
                <option value="created_asc">最早创建</option>
                <option value="due_asc">最早到期</option>
                <option value="due_desc">最晚到期</option>
              </select>
              <select id="priorityFilterSelect" aria-label="优先级筛选">
                <option value="">全部优先级</option>
                <option value="high">高优先级</option>
                <option value="medium">中优先级</option>
                <option value="low">低优先级</option>
              </select>
              <select id="statusFilterSelect" aria-label="任务状态筛选">
                <option value="">全部状态</option>
                <option value="todo">待开始</option>
                <option value="in_progress">进行中</option>
                <option value="blocked">阻塞中</option>
              </select>
              <button id="resetQueryButton" class="secondary-button compact-button" type="button">重置筛选</button>
            </div>
            <p class="due-snapshot" id="dueSnapshot">逾期 0 · 今日到期 0 · 未来7天 0 · 无到期日 0</p>
          </div>
          <p class="hint">可设置父任务做层级，或切换视图按项目/到期日查看。</p>
        </div>

        <div id="messageBar" class="message" aria-live="polite"></div>
        <div id="todoList" class="todo-list" aria-label="代办事项列表"></div>
        <div id="listActions" class="list-actions is-hidden">
          <span id="listProgress" class="list-progress"></span>
          <button id="loadMoreButton" class="secondary-button compact-button" type="button">加载更多</button>
        </div>
      </section>
    </main>

    <div id="actionModal" class="modal is-hidden" aria-hidden="true">
      <div class="modal-backdrop" data-modal-close="true"></div>
      <section class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <header class="modal-head">
          <h3 id="modalTitle">操作确认</h3>
          <button type="button" id="modalCloseButton" class="modal-close" aria-label="关闭弹窗">关闭</button>
        </header>
        <form id="modalForm" class="modal-form">
          <p id="modalDescription" class="modal-description"></p>

          <label class="field is-hidden" id="modalProjectField" for="modalProjectInput">
            <span>项目名</span>
            <input id="modalProjectInput" type="text" maxlength="80" placeholder="请输入新的项目名" />
          </label>

          <label class="field is-hidden" id="modalDueDateField" for="modalDueDateInput">
            <span>到期日期</span>
            <input id="modalDueDateInput" type="date" />
            <small>留空表示清除到期日。</small>
          </label>

          <label class="field is-hidden" id="modalImportModeField" for="modalImportModeSelect">
            <span>导入模式</span>
            <select id="modalImportModeSelect">
              <option value="merge">合并导入（保留现有任务）</option>
              <option value="replace">替换导入（清空后导入）</option>
            </select>
          </label>

          <label class="field is-hidden" id="modalImportFileField" for="modalImportFileInput">
            <span>导入文件（可选）</span>
            <input id="modalImportFileInput" type="file" accept="application/json,.json" />
            <small>选择文件后会自动填充到下方 JSON 文本框。</small>
          </label>

          <label class="field is-hidden" id="modalImportTextField" for="modalImportTextarea">
            <span>JSON 内容</span>
            <textarea
              id="modalImportTextarea"
              rows="8"
              placeholder='{"items":[{"title":"示例任务","project":"默认项目"}]}'
            ></textarea>
          </label>

          <p id="modalError" class="modal-error"></p>

          <div class="modal-actions">
            <button type="button" id="modalCancelButton" class="secondary-button">取消</button>
            <button type="submit" id="modalSubmitButton">确认</button>
          </div>
        </form>
      </section>
    </div>

    <template id="todoTemplate">
      <article class="todo-item">
        <button class="toggle" type="button" aria-label="切换完成状态"></button>
        <div class="todo-content">
          <div class="todo-tags"></div>
          <p class="todo-title"></p>
          <p class="todo-meta"></p>
        </div>
      </article>
    </template>

    <script src="/app.js"></script>
  </body>
</html>
